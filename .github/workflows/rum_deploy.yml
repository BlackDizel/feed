name: Deploy to rumsrv

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: [self-hosted, rumsrv]
    env:
      IMAGE_NAME_BASENAME: feed-admin
      DB_DIR: /var/feed_db
    steps:
    - uses: docker/setup-buildx-action@v2
      with:
        install: true
    - uses: actions/checkout@v3
# DB
    - name: setup db dir
      run: mkdir -p ${DB_DIR}
# ADMIN
    - name: build admin
      run: |
          docker buildx build \
             --output type=docker \
             -t $IMAGE_NAME_BASENAME:$GITHUB_SHA  \
             --build-arg API_URL=https://feed.cherepusick.keenetic.name/api \
             --build-arg NEW_API_URL=http://srv.rumyantsev.com:8888/api/v1 \
            .
    - name: stop admin
      run: docker rm -f $IMAGE_NAME_BASENAME
    - name: run admin
      run: |
        docker run -d \
          -p 4262:4262 -p 4301:4301 -p 8888:80 \
          -v ${DB_DIR}:/app/db \
          --restart=always \
          --name $IMAGE_NAME_BASENAME \
          $IMAGE_NAME_BASENAME:$GITHUB_SHA
# CLEANUP
    # - name: cleanup docker containers
    #   run: docker container prune --filter "until=168h" -f
    # - name: cleanup docker images
    #   run: docker image prune -a -f --filter "until=168h"
    # - name: cleanup docker build cache
    #   run: docker builder prune -a -f --filter "until=168h"
